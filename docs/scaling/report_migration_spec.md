# Migration Spec: Reporting to Event-Driven Architecture

## Overview
This document specifies the transition of the Reporting domain (`src/lib/reporting`) from a "Pull from Sheets" model to a "Push/Consume Events" model.

## 1. Data Source Mapping

| Legacy Source | New Event Source | Mapping Logic |
| :--- | :--- | :--- |
| `getFlowEvents(start, end)` | `eventClient.getEvents({ type: 'ledger.posted' })` | See `src/lib/reporting/mapper.ts` |
| `FlowEvent.segments` | `Event<LedgerPostedBody>.body.segments` | `body.segments` must carry `component_group`, `activity_type`, etc. |
| `FlowEvent.account_code` | `Event<LedgerPostedBody>.body.bucket` | `bucket` acts as the high-level account code (GRIND, CORE, etc.) |

### Critical Requirement: JSON Segments
The `ledger.posted` event body MUST include a `segments` JSON object. This allows the existing `aggregator.ts` logic to filter by:
- `component_group` (e.g. "Workouts")
- `activity_type` (e.g. "Sweets")
- `business_activity` (e.g. "Family")

## 2. New Event Logic

### `audit.segment.scored`
- **Trigger**: Generated by a background worker (Projector) daily/weekly.
- **Purpose**: To persist the calculated scores for each of the 7 accountability segments.
- **Payload**:
  ```typescript
  {
    day: "YYYY-MM-DD",
    segment: "segment_1_workouts",
    score: 85,
    evidence: ["event_id_1", "event_id_2"]
  }
  ```

### `report.generated`
- **Trigger**: Generated when `generateDepartmentReports` completes successfully.
- **Purpose**: To snapshot the "Department Report" state for historical viewing without re-computing.
- **Payload**:
  ```typescript
  {
    periodStart: "YYYY-MM-DD",
    periodEnd: "YYYY-MM-DD",
    reports: Record<DepartmentId, DepartmentReport>
  }
  ```

## 3. Backward Compatibility
- The `FlowEvent` interface in `src/lib/core/types.ts` remains the internal contract for `aggregator.ts`.
- `mapLedgerEventsToFlowEvents` adapts the new `LedgerPostedBody` to this legacy interface.
- This allows us to refactor the *storage* layer without rewriting the *business logic* of the CEO Report.

## 4. Future Work
- **EventClient Implementation**: Connect `src/lib/events/client.ts` to the real `POST /events/read` endpoint or Postgres DB.
- **Projector Worker**: Create a background job that listens for `ledger.posted` and emits `audit.segment.scored` automatically, rather than computing it on-demand in the API route.
